

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/Back.jpg">
  <link rel="icon" href="/img/Back.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Eutop1a">
  <meta name="keywords" content="">
  
    <meta name="description" content="PE文件格式介绍PE文件是Windows操作系统下使用的可执行文件格式。PE：Portable Executable   PE文件指的是32位的可执行文件，也成为PE32，64位的可执行文件称为PE+或者PE32+，是PE32文件的一种拓展（不是PE64） 观察PE文件的各个结构体成员的值，推荐使用CFF Explorer PE文件格式PE文件种类     种类 主拓展名    可执行 EXE,">
<meta property="og:type" content="article">
<meta property="og:title" content="PE文件格式学习">
<meta property="og:url" content="http://example.com/2023/03/06/PE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="Eutop1a">
<meta property="og:description" content="PE文件格式介绍PE文件是Windows操作系统下使用的可执行文件格式。PE：Portable Executable   PE文件指的是32位的可执行文件，也成为PE32，64位的可执行文件称为PE+或者PE32+，是PE32文件的一种拓展（不是PE64） 观察PE文件的各个结构体成员的值，推荐使用CFF Explorer PE文件格式PE文件种类     种类 主拓展名    可执行 EXE,">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/PE.jpg">
<meta property="article:published_time" content="2023-03-06T02:32:57.000Z">
<meta property="article:modified_time" content="2023-03-14T02:29:52.000Z">
<meta property="article:author" content="Eutop1a">
<meta property="article:tag" content="PE文件格式">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/PE.jpg">
  
  
  
  <title>PE文件格式学习 - Eutop1a</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"6pUwop9tNFxd6Q6rYe3f1kQs-MdYXbMMI","app_key":"hDKkIoSEagPcJCUvmd3oI6Sh","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Eutop1a&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/R-C.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="PE文件格式学习"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-06 10:32" pubdate>
          March 6, 2023 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.9k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          66 mins
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> times
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">PE文件格式学习</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="PE文件格式"><a href="#PE文件格式" class="headerlink" title="PE文件格式"></a>PE文件格式</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><strong>PE文件是Windows操作系统下使用的可执行文件格式</strong>。<em>PE：Portable Executable</em>  </p>
<p>PE文件指的是32位的可执行文件，也成为PE32，64位的可执行文件称为PE+或者PE32+，是PE32文件的一种拓展（<u>不是PE64</u>）</p>
<p>观察PE文件的各个结构体成员的值，推荐使用CFF Explorer</p>
<h2 id="PE文件格式-1"><a href="#PE文件格式-1" class="headerlink" title="PE文件格式"></a>PE文件格式</h2><center>PE文件种类</center>

<table>
<thead>
<tr>
<th>种类</th>
<th>主拓展名</th>
</tr>
</thead>
<tbody><tr>
<td>可执行</td>
<td>EXE, SCR</td>
</tr>
<tr>
<td>库</td>
<td>DLL, OCX, CRL, DRV</td>
</tr>
<tr>
<td>驱动程序</td>
<td>SYS, VXD</td>
</tr>
<tr>
<td>对象文件</td>
<td>OBJ</td>
</tr>
</tbody></table>
<p>以IDA pro(x32)为例</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306104549571.png" srcset="/img/loading.gif" lazyload alt="image-20230306104549571"></p>
<p>一般判断一个文件是否为PE文件主要看的就是他是否具有 <strong>MZ和PE</strong>这两个标志</p>
<h3 id="PE头"><a href="#PE头" class="headerlink" title="PE头"></a>PE头</h3><h4 id="DOS头"><a href="#DOS头" class="headerlink" title="DOS头"></a>DOS头</h4><p>在微软创建PE文件时，DOS文件正在被广泛使用，所以为了兼容DOS文件，DOS头出现了，也就是<strong>IMAGE_DOS_HEADER结构体</strong>，用于拓展已有的DOS EXE头</p>
<p>IMAGE_DOS_HEADER结构体的大小是64字节</p>
<p>在<strong>winnt.h</strong>中可以找到该结构体的定义</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306105159377.png" srcset="/img/loading.gif" lazyload alt="image-20230306105159377"></p>
<p>需要掌握的主要就是<u><strong>e_maigc和e_lfanew</strong></u>两个成员</p>
<p>e_magic：DOS签名，即4D5A —&gt; ASCII值 “MZ”</p>
<p>e_lfanew：指示NT头的偏移（根据不同文件拥有可变值）</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306105646938.png" srcset="/img/loading.gif" lazyload alt="image-20230306105646938"></p>
<p>在IDA pro(x32)这里，e_magic的值为4D5A，e_lfanew的值为00000100</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306223749684.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="DOS存根"><a href="#DOS存根" class="headerlink" title="DOS存根"></a>DOS存根</h4><p>DOS存根(stub)在DOS头下方，是可选项，主要有代码和数据混合而成，大小不固定(没有DOS存根，文件也可以正常运行)</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306105957244.png" srcset="/img/loading.gif" lazyload alt="image-20230306105957244"></p>
<p>在32位Windows OS环境下，PE loader识别到DOS头，该文件被识别为PE文件，这段DOS存根不会被执行。</p>
<p>在DOS环境中或者是DOS debug下，可以执行这段代码(不认识PE文件格式，所以识别为DOS文件)。</p>
<h4 id="NT头"><a href="#NT头" class="headerlink" title="NT头"></a>NT头</h4><p>在winnt.h文件中可以找到<strong>IMAGE_NT_HEADERS</strong>结构体的定义</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306110411583.png" srcset="/img/loading.gif" lazyload alt="image-20230306110411583"></p>
<p>IMAGE_NT_HEADERS主要由三个成员构成，第一个为签名(<strong>signature</strong>)结构体，值为50450000 (“PE” 00)。</p>
<p>另两外两个成员是文件头(<strong>FileHeader</strong>)和可选头(<strong>OptionalHeader</strong>)</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306111040054.png" srcset="/img/loading.gif" lazyload alt="image-20230306111040054"></p>
<p>IMAGE_NT_HEADERS结构体的大小为F8</p>
<h4 id="FileHeader"><a href="#FileHeader" class="headerlink" title="FileHeader"></a>FileHeader</h4><p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306111107961.png" srcset="/img/loading.gif" lazyload alt="image-20230306111107961"></p>
<p>IMAGE_FILE_HEADER有下面四个重要成员，如果他们设置不正确，可能导致文件无法正常运行</p>
<h5 id="Machine"><a href="#Machine" class="headerlink" title="Machine"></a>Machine</h5><p>每个CPU都拥有唯一的Machine码，兼容32为Intel x86芯片的Machine码为14C</p>
<p>下面是定义在winnt.h里的Machine码</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306111345971.png" srcset="/img/loading.gif" lazyload alt="image-20230306111345971"></p>
<h5 id="NumberOfSection"><a href="#NumberOfSection" class="headerlink" title="NumberOfSection"></a>NumberOfSection</h5><p>PE文件把代码，数据，资源等依据属性分类到各节区中存储</p>
<p>NumberOfSection 用来指出文件中存在的节区数量。</p>
<p><u>该值一定要大于0，且当定义的节区数量与实际截取不同时，将发生运行错误</u></p>
<h5 id="SizeOfOptionalHeader"><a href="#SizeOfOptionalHeader" class="headerlink" title="SizeOfOptionalHeader"></a>SizeOfOptionalHeader</h5><p>IMAGE_FILE_HEADER的最后一个成员为IMAGE_OPTIONAL_HEADER32结构体，SizeOfOptionalHeader用来指出IMAGE_OPTIONAL_HEADER32结构体的长度</p>
<h5 id="Characteristics"><a href="#Characteristics" class="headerlink" title="Characteristics"></a>Characteristics</h5><p>Characteristics用于标识文件的属性，文件是否是可运行的形态，是否为DLL文件等信息，以bit OR形式组合起来</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306112258529.png" srcset="/img/loading.gif" lazyload alt="image-20230306112258529"></p>
<p>主要记住0x0002和0x2000</p>
<p>其余的成员</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">TimeDateStamp;        <span class="hljs-comment">//时间戳：链接器填写的文件生成时间（不影响程序的运行）</span><br>PointerToSymbolTable; <span class="hljs-comment">//指向符号表的地址(主要用于调试)</span><br>NumberOfSymbols		  <span class="hljs-comment">//符号表中符号个数</span><br></code></pre></td></tr></table></figure>



<p><strong>IMAGE_FILE_HEADER结构体</strong></p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306112811250.png" srcset="/img/loading.gif" lazyload alt="image-20230306112811250"></p>
<p>machine对应的是8664，对应AMD64处理器。</p>
<p>NumberOfSection对应0060。</p>
<p>TimeDateStamp对应620F1879，转换为2022-02-18 11:54:33。</p>
<p>PointerToSymbolTable：00000000</p>
<p>NumberOfSymbols：00000000</p>
<p>SizeOfOptionalHeader：00F0</p>
<p>Characteristics：0022 –&gt; 0x2 | 0x20</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306223915210.png" srcset="/img/loading.gif" lazyload alt="image-20230306223915210"></p>
<h4 id="OptionalHeader"><a href="#OptionalHeader" class="headerlink" title="OptionalHeader"></a>OptionalHeader</h4><p>IMAGE_OPTIONAL_HEADER结构体</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306220049518.png" srcset="/img/loading.gif" lazyload alt="image-20230306220049518"></p>
<p>关注以下成员，如果他们设置不正确，可能导致文件无法正常运行</p>
<h5 id="Magic"><a href="#Magic" class="headerlink" title="Magic"></a>Magic</h5><p>为IMAGE_OPTIONAL_HEADER32时，Magic为10B</p>
<p>为IMAGE_OPTIONAL_HEADER64时，Magic为20B</p>
<h5 id="AddressOfEntryPoint"><a href="#AddressOfEntryPoint" class="headerlink" title="AddressOfEntryPoint"></a>AddressOfEntryPoint</h5><p>AddressOfEntryPoint拥有EP的RVA值，指出程序最先执行的代码起始地址</p>
<h5 id="ImageBase"><a href="#ImageBase" class="headerlink" title="ImageBase"></a>ImageBase</h5><p>进程虚拟内存的范围是0~0xFFFFFFFF(32位系统)</p>
<p>ImageBase指出文件的优先装入地址</p>
<p><strong>EXE、DLL文件被装入用户内存的0<del>7FFFFFFF中，SYS文件被载入内核内存的80000000</del>FFFFFFFF中</strong></p>
<p>一般使用开发工具创建好的<u>EXE文件，其ImageBase值位00400000，DLL文件的ImageBase值位10000000</u>(可以指定其他值)</p>
<p><u>执行PE文件时，PE装载器先创建进程，再将文件载入内存，然后把EIP设置为ImageBase+AddressOfEntryPoint</u></p>
<h5 id="SectionAlignment-FileAlignment"><a href="#SectionAlignment-FileAlignment" class="headerlink" title="SectionAlignment, FileAlignment"></a>SectionAlignment, FileAlignment</h5><p>FileAlignment指定了节区在磁盘文件中的最小单位</p>
<p>SectionAlignment指定了节区在内存中的最小单位</p>
<p>(一个文件中SectionAlignment, FileAlignment的值可能相同也可能不相同)</p>
<h5 id="SizeOfImage"><a href="#SizeOfImage" class="headerlink" title="SizeOfImage"></a>SizeOfImage</h5><p>加载PE文件到内存时，<strong>SizeOfImage指定了PE Image在虚拟内存中所占的空间大小</strong></p>
<p>(一般而言，文件的大小与加载到内存中的大小是不同的)</p>
<h5 id="SizeOfHeaders"><a href="#SizeOfHeaders" class="headerlink" title="SizeOfHeaders"></a>SizeOfHeaders</h5><p><strong>SizeOfHeaders用来指出整个PE头的大小</strong>，第一节区所在位置与SizeOfHeaders距文件开始偏移的量相同</p>
<h5 id="Subsystem"><a href="#Subsystem" class="headerlink" title="Subsystem"></a>Subsystem</h5><p>Subsystem的值用来区分系统驱动文件<code>*.sys</code> 和普通的可执行文件 <code>*.exe, *.dll</code></p>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Driver文件</td>
<td>系统驱动(*.sys)</td>
</tr>
<tr>
<td>2</td>
<td>GUI文件</td>
<td>窗口应用程序(ida.exe)</td>
</tr>
<tr>
<td>3</td>
<td>CUI文件</td>
<td>控制台应用程序(cmd.exe)</td>
</tr>
</tbody></table>
<h5 id="NumberOfRvaAndSizes"><a href="#NumberOfRvaAndSizes" class="headerlink" title="NumberOfRvaAndSizes"></a>NumberOfRvaAndSizes</h5><p><strong>NumberOfRvaAndSizes用来指定DataDirectory(IMAGE_OPTIONAL_HEADER32最后一个成员)数组的个数</strong></p>
<h5 id="DataDirectory"><a href="#DataDirectory" class="headerlink" title="DataDirectory"></a>DataDirectory</h5><p>DataDirectory是由IMAGE_DATA_DIRECTORY结构体组成的数组</p>
<p>在010Editor下可以看到</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306222456975.png" srcset="/img/loading.gif" lazyload alt="image-20230306222456975"></p>
<p>使用CFF Explorer查看，可以很详细的看到每个成员的值</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306222841182.png" srcset="/img/loading.gif" lazyload alt="image-20230306222841182"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 32位选项头结构体：_IMAGE_OPTIONAL_HEADER</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_OPTIONAL_HEADER</span></span><br><span class="hljs-class">&#123;</span><br>    WORD   Magic;                            <span class="hljs-comment">//* PE标志字：32位（0x10B），64位（0x20B）</span><br>    BYTE   MajorLinkerVersion;               <span class="hljs-comment">//  主链接器版本号</span><br>    BYTE   MinorLinkerVersion;               <span class="hljs-comment">//  副链接器版本号</span><br>    DWORD  SizeOfCode;                        <span class="hljs-comment">//  代码所占空间大小（代码节大小）</span><br>    DWORD  SizeOfInitializedData;         <span class="hljs-comment">//  已初始化数据所占空间大小</span><br>    DWORD  SizeOfUninitializedData;           <span class="hljs-comment">//  未初始化数据所占空间大小</span><br>    DWORD  AddressOfEntryPoint;               <span class="hljs-comment">//* 程序执行入口RVA，(w)(Win)mainCRTStartup：即0D首次断下来的自进程地址</span><br>    DWORD  BaseOfCode;                        <span class="hljs-comment">//  代码段基址</span><br>    DWORD  BaseOfData;                        <span class="hljs-comment">//  数据段基址</span><br>    DWORD  ImageBase;                     <span class="hljs-comment">//* 内存加载基址，exe默认0x400000，dll默认0x10000000</span><br>    DWORD  SectionAlignment;              <span class="hljs-comment">//* 节区数据在内存中的对齐值，一定是4的倍数，一般是0x1000(4096=4K)</span><br>    DWORD  FileAlignment;                 <span class="hljs-comment">//* 节区数据在文件中的对齐值，一般是0x200(磁盘扇区大小512)</span><br>    WORD   MajorOperatingSystemVersion;      <span class="hljs-comment">//  要求操作系统最低版本号的主版本号</span><br>    WORD   MinorOperatingSystemVersion;      <span class="hljs-comment">//  要求操作系统最低版本号的副版本号</span><br>    WORD   MajorImageVersion;                <span class="hljs-comment">//  可运行于操作系统的主版本号</span><br>    WORD   MinorImageVersion;                <span class="hljs-comment">//  可运行于操作系统的次版本号</span><br>    WORD   MajorSubsystemVersion;            <span class="hljs-comment">//  主子系统版本号：不可修改</span><br>    WORD   MinorSubsystemVersion;            <span class="hljs-comment">//  副子系统版本号</span><br>    DWORD  Win32VersionValue;             <span class="hljs-comment">//  版本号：不被病毒利用的话一般为0,XP中不可修改</span><br>    DWORD  SizeOfImage;                       <span class="hljs-comment">//* PE文件在进程内存中的总大小，与SectionAlignment对齐</span><br>    DWORD  SizeOfHeaders;                 <span class="hljs-comment">//* PE文件头部在文件中的按照文件对齐后的总大小（所有头 + 节表）</span><br>    DWORD  CheckSum;                      <span class="hljs-comment">//  对文件做校验，判断文件是否被修改：3环无用，MapFileAndCheckSum获取</span><br>    WORD   Subsystem;                        <span class="hljs-comment">//  子系统，与连接选项/system相关：1=驱动程序，2=图形界面，3=控制台/Dll</span><br>    WORD   DllCharacteristics;               <span class="hljs-comment">//  文件特性</span><br>    DWORD  SizeOfStackReserve;                <span class="hljs-comment">//  初始化时保留的栈大小</span><br>    DWORD  SizeOfStackCommit;             <span class="hljs-comment">//  初始化时实际提交的栈大小</span><br>    DWORD  SizeOfHeapReserve;             <span class="hljs-comment">//  初始化时保留的堆大小</span><br>    DWORD  SizeOfHeapCommit;              <span class="hljs-comment">//  初始化时实际提交的堆大小</span><br>    DWORD  LoaderFlags;                       <span class="hljs-comment">//  已废弃，与调试有关，默认为 0</span><br>    DWORD  NumberOfRvaAndSizes;               <span class="hljs-comment">//  下边数据目录的项数，此字段自Windows NT发布以来,一直是16</span><br>    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];<span class="hljs-comment">// 数据目录表</span><br>&#125; IMAGE_OPTIONAL_HEADER32, * PIMAGE_OPTIONAL_HEADER32;<br> <br><span class="hljs-comment">//* 字段6：AddressOfEntryPoint 表 程序入口RVA，即OEP:</span><br>      EOP:程序入口点，壳相关概念<br>      OEP:原本的程序入口点（实际为偏移，+模块基址=实际入口点）<br>      EP: 被加工后的入口点<br><span class="hljs-comment">//* 字段9：ImageBase 表 模块加载基地址，exe默认0x400000，dll默认0x10000000</span><br>      建议装载地址：exe映射加载到内存中的首地址= PE <span class="hljs-number">0</span>处，即实例句柄hInstance<br>      一般而言，exe文件可遵从装载地址建议，但dll文件无法满足<br><span class="hljs-comment">//* 尾字段：DataDirectory 表 数据目录表，用来定义多种不通用处的数据块。</span><br>      存储了PE中各个表的位置，详情参考IMAGE_DIRECTORY_ENTRY...系列宏<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-270210.htm">原创]归纳PE结构基础知识，顺便手撕个PE-编程技术-看雪论坛-安全社区|安全招聘|bbs.pediy.com (kanxue.com)</a> </p>
<h4 id="节区头"><a href="#节区头" class="headerlink" title="节区头"></a>节区头</h4><p>节区头定义了个节区的属性</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>访问权限</th>
</tr>
</thead>
<tbody><tr>
<td>code</td>
<td>执行，读取权限</td>
</tr>
<tr>
<td>data</td>
<td>非执行，读写权限</td>
</tr>
<tr>
<td>resource</td>
<td>非执行，读取权限</td>
</tr>
</tbody></table>
<p>节区头是由IMAGE_SECTION_HEADER结构体组成的数组，每个结构体对应一个节区</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306223555772.png" srcset="/img/loading.gif" lazyload alt="image-20230306223555772"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// IMAGE_SECTION_HEADER 节表结构体，大小40B</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_SECTION_HEADER</span> &#123;</span><br>  BYTE  Name[IMAGE_SIZEOF_SHORT_NAME];  <span class="hljs-comment">// 节表名称：描述性字段</span><br>  <span class="hljs-comment">// 下方4个字段：从文件S1处开始，拷贝S2大小的数据，到内存S3处，有效数据占用内存S4大小</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>    DWORD PhysicalAddress;<br>    DWORD VirtualSize;         <span class="hljs-comment">// S4:内存大小</span><br>  &#125; Misc;<br>  DWORD VirtualAddress;          <span class="hljs-comment">// S3:内存地址：基于模块基址</span><br>  DWORD SizeOfRawData;           <span class="hljs-comment">// S2:文件大小</span><br>  DWORD PointerToRawData;        <span class="hljs-comment">// S1:文件偏移</span><br>  DWORD PointerToRelocations;    <span class="hljs-comment">// 无用</span><br>  DWORD PointerToLinenumbers;    <span class="hljs-comment">// 无用</span><br>  WORD  NumberOfRelocations;    <span class="hljs-comment">// 无用</span><br>  WORD  NumberOfLinenumbers;    <span class="hljs-comment">// 无用</span><br>  DWORD Characteristics;     <span class="hljs-comment">// 节属性，取值IMAGE_SCN_...系列宏(bit OR)</span><br>&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;<br></code></pre></td></tr></table></figure>

<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230306223719784.png" srcset="/img/loading.gif" lazyload alt="image-20230306223719784"></p>
<h3 id="RVA-to-RAW"><a href="#RVA-to-RAW" class="headerlink" title="RVA to RAW"></a>RVA to RAW</h3><h4 id="Offset"><a href="#Offset" class="headerlink" title="Offset"></a>Offset</h4><p>是指数据在文件中相对于文件开始位置的偏移</p>
<h4 id="VA"><a href="#VA" class="headerlink" title="VA"></a>VA</h4><p>是指数据在进程虚拟内存的绝对地址</p>
<h4 id="RVA"><a href="#RVA" class="headerlink" title="RVA"></a>RVA</h4><p>是指数据在进程虚拟内存中某个基准位置（ImageBase）开始的相对地址</p>
<h4 id="VA和RVA满足的换算关系"><a href="#VA和RVA满足的换算关系" class="headerlink" title="VA和RVA满足的换算关系"></a>VA和RVA满足的换算关系</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">RVA</span> <span class="hljs-operator">=</span> VA - ImageBase<br></code></pre></td></tr></table></figure>

<h4 id="文件偏移（RAW）"><a href="#文件偏移（RAW）" class="headerlink" title="文件偏移（RAW）"></a>文件偏移（RAW）</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">RAW</span> = RVA - VirtualAddress + PointerToRawData<br></code></pre></td></tr></table></figure>

<p>注：其中VirtualAddress为RVA所在节区的VA（VA - ImageBase）地址，PointerToRawData为RVA所在节区对应在文件中节区的偏移（Offset）</p>
<h3 id="IAT"><a href="#IAT" class="headerlink" title="IAT"></a>IAT</h3><h4 id="IMAGE-IMPORT-DESCRIPTOR"><a href="#IMAGE-IMPORT-DESCRIPTOR" class="headerlink" title="IMAGE_IMPORT_DESCRIPTOR"></a>IMAGE_IMPORT_DESCRIPTOR</h4><p>该结构体中记录着PE文件要导入哪些库文件</p>
<p>在winnt.h中可以找到关于他的定义</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230313110516820.png" srcset="/img/loading.gif" lazyload alt="image-20230313110516820"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        DWORD   Characteristics;           <br>        DWORD   OriginalFirstThunk;<span class="hljs-comment">//INT(Import Name Table) address (RVA)         </span><br>    &#125; DUMMYUNIONNAME;<br>    DWORD   TimeDateStamp;                 <br>    DWORD   ForwarderChain;                 <br>    DWORD   Name;					<span class="hljs-comment">//library name string address(RVA)</span><br>    DWORD   FirstThunk; 			<span class="hljs-comment">//IAT(Import Address Table) address(RVA)                 </span><br>&#125; IMAGE_IMPORT_DESCRIPTOR;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_BY_NAME</span> &#123;</span><br>    WORD    Hint;					<span class="hljs-comment">//ordinal</span><br>    CHAR   Name[<span class="hljs-number">1</span>];					<span class="hljs-comment">//function name string</span><br>&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;<br></code></pre></td></tr></table></figure>

<p>执行一个程序时，导入多少个库就存在多少个IMAGE_IMPORT_DESCRIPTOR结构体，这些结构体形成了数组，且以NULL结构体结束。</p>
<p>注意：</p>
<ul>
<li><p>INT 和 IAT 是DWORD数组，以NULL结束</p>
</li>
<li><p>INT中各元素的值位IMAGE_IMPORT_BY_NAME结构体指针</p>
</li>
<li><p>INT 与 IAT的大小应该相同</p>
</li>
</ul>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230313111429483.png" srcset="/img/loading.gif" lazyload alt="image-20230313111429483"></p>
<h4 id="PE装载器把导入函数输入至IAT的顺序"><a href="#PE装载器把导入函数输入至IAT的顺序" class="headerlink" title="PE装载器把导入函数输入至IAT的顺序"></a>PE装载器把导入函数输入至IAT的顺序</h4><p>IAT输入顺序：</p>
<ol>
<li><p>读取IID的Name成员，获取库名称字符串”kernal32.dll”</p>
</li>
<li><p>装载相应库：LoadLibrary(“kernal32.dll”)</p>
</li>
<li><p>读取IID的OriginalFirstThunk成员，获取INT地址</p>
</li>
<li><p>逐一读取INT中数组的值，获取相应IMAGE_IMPORT_BY_NAME地址(RVA)</p>
</li>
<li><p>使用IMAGE_IMPORT_BY_NAME的Hint或Name成员，获取相应函数的起始地址：GetProcAddress(IMAGE_IMPORT_BY_NAME.NAME)</p>
<p>例如GetProcAddress(“GetCurrentThreadId”)</p>
</li>
<li><p>读取IID的FirstThunk(IAT)成员，获得IAT地址</p>
</li>
<li><p>将上面获得的函数地址输入相应IAT数组值</p>
</li>
<li><p>重复4~7，直到INT结束（遇到NULL）</p>
</li>
</ol>
<p>稍微总结一下，整个过程就是找到IID，获得库的INT地址，获得对应函数的起始地址，获得IAT地址，将函数地址写入IAT</p>
<h3 id="EAT"><a href="#EAT" class="headerlink" title="EAT"></a>EAT</h3><p><strong>EAT是一种核心机制，它使不同的应用程序可以调用库文件中提供的函数</strong></p>
<h4 id="IMAGE-EXPORT-DIRECTORY"><a href="#IMAGE-EXPORT-DIRECTORY" class="headerlink" title="IMAGE_EXPORT_DIRECTORY"></a>IMAGE_EXPORT_DIRECTORY</h4><p>IMAGE_EXPORT_DIRECTORY结构体保存着导出信息</p>
<p><u>IMAGE_OPTIONAL_HEADER32.DateDirectory[0].VirtualAddress的值即是IMAGE_EXPORT_DIRECTORY结构体数组的起始地址</u></p>
<p>IMAGE_EXPORT_DIRECTORY</p>
<p>winnt.h头中的定义</p>
<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230313121213457.png" srcset="/img/loading.gif" lazyload alt="image-20230313121213457"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span><br>    DWORD   Characteristics;<br>    DWORD   TimeDateStamp;			<span class="hljs-comment">//creation time date stamp</span><br>    WORD    MajorVersion;<br>    WORD    MinorVersion;<br>    DWORD   Name;					<span class="hljs-comment">//address of library file name</span><br>    DWORD   Base;					<span class="hljs-comment">//ordinal base</span><br>    DWORD   NumberOfFunctions;		<span class="hljs-comment">//number of functions</span><br>    DWORD   NumberOfNames;			<span class="hljs-comment">//number of names</span><br>    DWORD   AddressOfFunctions; 	<span class="hljs-comment">//address of function start address array</span><br>    DWORD   AddressOfNames;         <span class="hljs-comment">//addresss of function name string array</span><br>    DWORD   AddressOfNameOrdinals;  <span class="hljs-comment">//addresss of ordinal array</span><br>&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;<br></code></pre></td></tr></table></figure>



<p><img src="https://renovice-1311449499.cos.ap-chongqing.myqcloud.com/img/image-20230313121347228.png" srcset="/img/loading.gif" lazyload alt="image-20230313121347228"></p>
<p>GetprocAddress()函数引用EAT来获取指定API的地址。</p>
<h4 id="GetProcAddress操作原理"><a href="#GetProcAddress操作原理" class="headerlink" title="GetProcAddress操作原理"></a>GetProcAddress操作原理</h4><ol>
<li>利用AddressOfNames成员转到”函数名称数组“</li>
<li>”函数名称数组“中存储着字符串地址。通过strcmp，查找指定的函数名称（数组的索引称为name_index）</li>
<li>利用AddressOfNameOrdinals成员转到orinal数组</li>
<li>在orinal数组中通过name_index查找相应orinal值</li>
<li>利用AddressOfFunctions成员转到”函数数组地址“（EAT）</li>
<li>在”函数地址数组“中将刚刚求得的oridinal用作数组索引，获得指定函数的起始地址</li>
</ol>
<p>hint：对于没有函数名称的导出函数，可以通过Ordinal查找到它们的地址。从Ordinal值中减去IMAGE_EXPORT_DIRECTORY.Base成员后得到一个值，使用该值作为”函数地址数组“的索引，即可查找到相应函数的地址</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="category-chain-item">学习笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/PE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/">#PE文件格式</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>PE文件格式学习</div>
      <div>http://example.com/2023/03/06/PE文件格式学习/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Eutop1a</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>March 6, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/04/01/2023XCTF-Final/" title="2023XCTF-Final">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2023XCTF-Final</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/01/30/2022%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/" title="2022Annual Summary">
                        <span class="hidden-mobile">2022Annual Summary</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"6pUwop9tNFxd6Q6rYe3f1kQs-MdYXbMMI","appKey":"hDKkIoSEagPcJCUvmd3oI6Sh","path":"window.location.pathname","placeholder":"Say something","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"en-US","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":"ture"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
